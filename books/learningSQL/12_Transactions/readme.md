# Транзакции

## Многопользовательские базы данных

Т.к. БД может иметь множество одновременных пользователей, то для консистентности и целостности данных СУБД используют блокировки, большинство СУБД применяют одну из двух стратегий:
* Пользователи, пишушие в БД должны запрашивать _блокировку записи (write lock)_ для измения данных. А пользователи, считывающие из БД, должны запрашивать и получать от сервера _блокировку чтения(read lock)_ для запросов к данным. Пр этом чтение может осуществляются одновременно несколькими пользователями, для каждой таблицы(или её части) одновременно выдаётся только одна блокировака записи, и запросы на чтения блокируются пока не бдует снята блокировка записи.
* Пользователи, пишушие в БД запрашивают блокировку записи, а пользователи читающие не запрашивают никаких блокировок. Вместо этого сервер гарантирует, что читатель видит напротиворичивые данные, начиная с момента записи до его завершеня. Такой подход называется `контроль версий`.

В MySQL используются оба подхода в зависимости от выбраного механизма хранения (storage engine).

Блокировки выполняются на трёх уровнях:
* Блокировка таблицы — предоствращает одновременное измение данных одной таблицы.
* Блокировка страницы — предоствращает одновременное измения данных одной страницы таблицы(страница сегмент памяти, обычно 2-16Кбайт).
* Блокирование строки — предоствращает измения одной строки таблицы.

## Транзакции

Транзация — механизм группировки нескольких SQL-выражений, позволяющий успешно выполнится _всем_ или _не одному_ из них. 

СУБД обрабатывают создание транзакций одним из двух способов:
* Активная транзакция всегда присутвует для каждого сеанса работы с БД, поэтому нет не необходимости, ни способа явного начала транзакций. По завершению транзакции автоматически начинается новая.
* Выражения выполяняются независимо друг от друга, для начала транзакции её нужно запустить явно.

В MySQL используется 2й подход.
При необходимости MySQL можно перевести режим работы реализующий 1й подхдом:
```SQL
SET AUTOCOMMIT=0
```

Чтобы начать транзацию нужно использовать:
```SQL
start transaction
```
перед началом SQL-выражений.

Затем для завершения транзации используется команда:
```SQL
commit
```
которая закрепляет измения в БД

Если измения закреплять не нужно, то команда:
```SQL
rollback
```
откатит измения.

Помимо явных щавершений транзакции она может так-же завершится неявно:
* Если сервер выключился, в этом случае откат будет произведён автоматически при включении сервера.
* Выполнения SQL-выражений для управления схемой, например `ALTER TABLE`, что приводит к коммиту транзакции и началу новой.
* Вызов `START TRANSACTION` при неоконченной транзакции приведёт к коммиту и началу новой транзакции.
* Преждевременное завершения транзакции, если сервер выявил взаимоблокровку(deadlock) и решил, что виновата в этом текущая транзакция. Будет произведён откат и выведена ошибка.

### Точки сохранения транзакций

Если нужно чтобы транзакция откатывала не все измения, совершённые в ней в транзакции можно установить _точки сохранения (savepoint)_, и использовать их для отката к определённому месту в транзакции, а не к началу:
```SQL
SAVEPOINT my_savepoint;
```
Для отката к точке:
```SQL
ROLLBACK TO SAVEPOINT my_savepoint;
```
После перехода к точке сохранения нужно сделать `commit` для фиксации изменений.
Если использовать `ROLLBACK` без указания точки сохранения, то будет произведён полный откат до момента начала транзакции.

## Мезанизмы хранения MySQL

Механизмы зранения MySQL 5.6:

* MyISAM — нетранзакционныый мехнизм, использующий блокировку таблиц.
* MEMORY — нетранзакционный механизм, применяемый для таблиц в оперативной памяти.
* BDB — транзакционный механизм, использующий блокировку на уровне страницы.
* InnoDB — транзакционный механизм, использующий блокировку на уровне строки.
* Merge — специальный мехнизм предназначенный для создания нескольких идентиячных таблиц MyISAM, ведущих при этом себя как одна таблица(сегментированные таблицы)
* NDB — специальный механизм, предназначенный для распределения одной БД по нескольким серверам(класторизация)
* Archive — специальный мезанизм, предназначенный для хранения больших объёмов неиндексированных данных, преимущественно для архивных целей.
