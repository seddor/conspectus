# Уход за репозиторием и восстановление данных

## Уход за репозиторием

Время от времени git автоматически выполняет сборку мусора. Например, если накопилось много рыхлых файлов или много пакетов, то git запускает `git gc` для упаковки. 
gc(garbage collect) упаковывает рыхлые файлы в pack-файлы, объеденяет множество pack-файлов, и удаляет недостижимые объекты, хранящееся дольше нескольких месяцев.

Таже gc упаковывает ссылки в единый файл. Упакованые ссылки хранятся в `.git/packed-refs`. 
При обновлении ссылки git положит новые ветки в `.git/refs/heads`. При получении хеша для ссылки сначало они будут искатся в `refs/heads` а после этого в `packed-refs`.

## Востановление данных

Если так получилось, что была удалена нужная ветка или засечены нужные измения в git есть возможность вернуть некоторые вещи назад.

```bash
git reflog
```
В reflog записываются все изменения `HEAD`.

Например был сделан `reset --hard` на два коммита назад:
```
$ git reflog
1a410ef HEAD@{0}: reset: moving to 1a410ef
ab1afef HEAD@{1}: commit: modified repo.rb a bit
484a592 HEAD@{2}: commit: added repo.rb
```
`HEAD@{1}` и `HEAD@{2}` коммиты на которые когда-то указывал HEAD.

Более подробную информацию можно получить использую:
```bash
git log -g
```

Данные reflog хранятся в `.git/logs/`. 

Если потярянные коммиты не доступны из reflog, то можно попробовать достать их из внутреней базы объектов git:
```bash
git fsck --full
```
Команда проверяет внутренюю базу git целостность, выполнение с `--full` выведет список недостижимых(из других объктов) объектов.

## Удаление объектов

**Удлаение объектов переписывает истоию и соотвено комииты**

Допустим надо удалить большие файлы из истории. 

1. Найти файлы по размеру в пакетах можно командой:
```bash
git verify-pack
```
В выводе она отображает размеры файлов:
```
dadf7258d699da2c8d89b09ef6670edb7d5f91b4 commit 229 159 12
033b4468fa6b2a9547a70d88d1bbe8bf3f9ed0d5 blob   22044 5792 4977696
82c99a3e86bb1267b236a4b6eff7868d97489af1 blob   4975916 4976258 1438
```
2. Узнать подробне о файле можно с помощью:
```bash
git rev-list --objects --all | grep 82c99a3
```
* --objects — в ответе будут показаны хэши всех коммитов, а также хэши объектов и соотвующие им имена файлов.
3. Чтобы удалить файл из всех деревьев в прошлом нужно получить все коммиты, которые меняли этот файл:
```bash
git log --oneline --branches -- git.tgz
```
4. Нужно удалить файл начиная с первого коммта, где он встречается, с помощью `filter-branch`:
```bash
git filter-branch --index-filter \
  'git rm --ignore-unmatch --cached git.tgz' -- 7b30847^..
```
5. Файл удалён из истории, но ссылки на него остались, нужно их очистить и перепаковать объекты:
```bash
rm -Rf .git/refs/original
rm -Rf .git/logs/
git gc
```
6. Остатки большого файла могут ещё находится в рыхлых объектах, но при любой передачи измений наружу они уже передаватся не будут, если нужно удалить локальные остатки, то можно сделать:
```bash
git prune --expire now
```
