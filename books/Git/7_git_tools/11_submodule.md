# Подмодули

[Submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules)

Подмодули представляют из себе git-репозитории, которые встраиваются в другой git-репозиторий.

## добавление

`git submodule add <git_repository_url> [sunmodule_name]`

`git_repository_url` — может быть ssh/https ссылкой на репозиторий.
`sunmodule_name` — имя подмодуля, которое будет использоваться в основном репозитории.

## файл .gitmodules

После добавление подмодулей git создаст файл .gitmodules в корне репозитория.
Файл содержит все настройки связаные с подмодулями, выглядит он примерно так:

```ini
[submodule "foo"]
	path = foo
	url = git@example.com:foo.git
[submodule "bar"]
	path = bar
	url = https://gist.example.com/bar.git
[submodule "baz"]
	path = baz
	url = https://gist.example.com/baz.git
    branch = stable
```
Измения можно вносить руками, или командой `git config -f .gitmodules`
Также настройки хранятся локально в `.git/config`

## обновление

Поскольку подмодули по сути являются обычными git-репозитории, то обновляются они соотвенно. 
Для того чтобы получить обновления для подмодуля, нужно зайти в директорию подмодуля и сделать там обновления из репозитория(pull/frtch && merge).
Затем перейти в директорию основного модуля и сделать коммит с информацией об обновлении.

Также можно воспользываться командой `git submodule update --remote [submodle]`. Которая сделает тоже самое.
По умолчанию будет обновлять все подмодули, если в submodle не указан конкретный.

По умолчанию git автоматически обновляет резпозитории по последней версии ветки `master`.
Изменить это можно в файле `.gitmodules`(глобально) или в `.git/config`(локально). 

Например, сделаем глобальное измения ветки для подмодуля `foo` на ветку `stable`.

`git config -f .gitmodules submodule.foo.branch stable`

После этого в файле `.gitmodules`, появится строчка о том, что отслеживаемая ветка для подмодуля изменилась:
```ini
[submodule "foo"]
	path = foo
	url = git@example.com:projects/foo.git
    branch = stable
```

`git config submodule.foo.branch stable`

Сделает тоже самое, но локально, в файле `.git/config`

Если имеются локальные измения в подмодуле, то можно вопользоваться прамертом `merge` или `rebase`.
`git submodule update --remote --merge`
Тогда git будет мерджить локальные и глобальные измения.
Если не указывать парметр, то git просто обновит подмодуль, до состояния удалёного репозитория,
Таким образом локальные измения будут отброшены.
При возникновении конфликтов при мердже их можно решать обычными способамми.


## отправка измений

После локального измения модуля нужно запушить его измения в репозиторий подмодуля и запушить измения в основном репозитории модуля.
При пуше иземений в основом репозитории, можно сделать проверку на то, что все подмодуле были тоже запушены

`git push --recurse-submodules=check` — перед пушем проверит, были ли отправлены все измения на удлалённый сервер, для всех подмодулей
, если будут найдены неотправленые, то пуш завершится неудачей.

Для того чтобы запушить все измения, включая измения в подмодулях, можно воспользоваться:
`git push --recurse-submodules=on-demand`
Иначе сделать это руками в каждом подмодуле, с незапушеными изменениями.
При возникновении проблем с пушем подмодуля весь пуш завершается неудачей.

## Клонирование проекта с подмодулями

При клонировании проекта подмодули не скачиваются автоматически, для них создаётся только пустые директории.

Чтобы получить подмодули надо:
1. Инициализировать локальный файл конфигурации подмодулей:
```bash
git submodule init
```
2. Склонировать все подмодули:
```bash
git submodule update
```
