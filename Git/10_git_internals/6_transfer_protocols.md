# Протоколы передачи

Git умеет передавать данные между репозиториями использую "глупый" и "умный" протокол.

## Глупый протокол

Если резрешить доступ на чтение к репозиторию через HTTP, то скорее всего будет использоватся "глупый" протокол. Он называется так, потому что для его работы не требуется специфичных для Git операций на стороне сервера, весь процесс представляет из себя серию HTTP GET запросов.

Сейчас он используется редко, и является не безопасным, поэтому стоит использовть "умный" протокол.

### Процесс получения данных из репозитория

Последовательность команд происходит при выполении команды:
```bash
git clone http://server/simplegit-progit.git
```

1. Для начала загружаются `info/refs`. Файл записывается командой `update-server-info`.
```
GET info/refs
```
В ответ приходит список удалённых веток и их хеши
2. Нужно посмотреть куда ссылается HEAD для переключения.
```
GET HEAD
```
В ответ приходит текущая ссылка
3. Далее загружаются объекты(`onjects`) из репозитория, по хешам из `info/refs`. Объекты получаются в рыхлом формате.
4. Объекты разархивируется
5. Если при получении объекта сервер ответил 404, то объекта нет в рыхлом формате. 
* Git проверяет список альтернативных репозиториев
```
GET objects/info/http-alternates
```
Если запрос возвращает не пустой файл, то git пытается найти нужные объекты в альтернативных репозиториях
* Если объект не найден в альтернативных репозитория, то Git ищет файлы в pack-файлах
```
GET objects/info/packs
```

## Умный протокол

Глупый протокол прост, но он довступен только для чтения. Для работы "умного" протокола требуется запуск на сервере специальных процессов занимающихся работой с git-репозиторием.

### Загрузка на сервер

Для загрузки используются процессы `send-pack` и `receive-pack`. `send-pack` запускается на клиенте и подключается к `receive-pack` на сервере.

#### SSH

При выполнении:
```bash
git push origin master
```
1. Git запускает процесс `send-pack`, который устанавливает соединение с сервером по SSH. 
```
ssh -x git@server "git-receive-pack 'simplegit-progit.git'"
```
ответ:
```
005bca82a6dff817ec66f4437202690a93763949 refs/heads/master report-status \
	delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1+github-607-gfba4028 delete-refs
003e085bb3bcb608e1e84b2432f8ecbe6306e7e7 refs/heads/topic
0000
```
2. Команда `git-receive-pack` посылает в ответ по доной строке на каждую имеющихся ссылок. Первая строка ответа так-же содержит список возможностей сервера.

Каждая строка начинается с 4х-байтового шестнадцатеричного значения, содержащего длину оставщейся части строки. 
Последняя строка заканчивается на 0000.
3. После этого `send-pack` определяет коммиты, которые есть локально, но остсутвуют на сервере. Для каждой ссылки, которая будет обновлена командой `push`, процесс `send-pack` передаёт процессу `receive-pack` эти данные. 
4. Git посылает по строке содержащей собственную длину, старый хэш, новый хэш и имя ссылки, для каждый обновляемой ссылки.
В первой строке посылаются возможности клиента.
Хэш из нулей говорит, что раньше такой ссылки не было, при удалении ветки нули были бы справа.
5. Клиент посылает pack-файлы с объектами, которых нет на сервере.
6. Сервер передаёт статус операции — успех или ошибку.

#### HTTP(S)

Процесс похож на HTTP, с разницей в установке соединения.

1. Соединение начинается с такого запроса:
```
GET http://server/simplegit-progit.git/info/refs?service=git-receive-pack
001f# service=git-receive-pack
```
ответ:
```
000000ab6c5f0e45abd7832bf23074a333f739977c9e8188 refs/heads/master \
	report-status delete-refs side-band-64k quiet ofs-delta \
	agent=git/2:2.1.1~vmg-bitmaps-bugaloo-608-g116744e
0000
```
2. Git передаёт данные полученые от `git-upload-pack`
```
POST http://server/simplegit-progit.git/git-receive-pack
```
Запрос включает в себя результаты `send-pack` и собственные pack-файлы. 

### Скачивание данных

Для получения данных используеются процессы `fetch-pack` и `upload-pack`. Клиент запускает `fetch-pack`, который подключается к `upload-pack` на сервере для определения подлежащих передачи данных.

#### SSH

1. Установление соединение по ssh
```
ssh -x git@server "git-upload-pack 'simplegit-progit.git'"
```
2. Как только `fetch-pack` подключается к `upload-pack`, он отсылает обратно следующее:
```
00dfca82a6dff817ec66f44342007202690a93763949 HEADmulti_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fca82a6dff817ec66f44342007202690a93763949 refs/heads/master
0000
```
Это похоже на ответ `receive-pack`, но с другими возможностями. Также `upload-pack` отсылает ссылку `HEAD`, чтобы клиент понимал, на какую ветку переключится, если выполняется клонирование.
3. `fetch-pack` смотрит на объекты, имеющиеся в наличии, и для недостоющих ответает `want <hash>`. Для имеющихся отправляется ответ с `have <hash>`. В конце списка пишется `done`. Что даёт понять `upload-pack`, что пока начинать отправлять успакованный pack-файл:
```
0054want ca82a6dff817ec66f44342007202690a93763949 ofs-delta
0032have 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7
0000
0009done
```

#### HTTP(S)

Процесс начиается с двух HTTP запросов
1. GET запрос на тот же урл, что в "глупом" протоколе:
```
GET $GIT_URL/info/refs?service=git-upload-pack
```
ответ:
```
001e# service=git-upload-pack
000000e7ca82a6dff817ec66f44342007202690a93763949 HEADmulti_ack thin-pack \
	side-band side-band-64k ofs-delta shallow no-progress include-tag \
	multi_ack_detailed no-done symref=HEAD:refs/heads/master \
	agent=git/2:2.1.1+github-607-gfba4028
003fca82a6dff817ec66f44342007202690a93763949 refs/heads/master
0000
```
Похоже на использование `git-upload-pack` по SSH, только обмен данных происходится отдельным запросом:
```
POST $GIT_URL/git-upload-pack HTTP/1.0
```
ответ:
```
0032want 0a53e9ddeaddad63ad106860237bbf53411d11a7
0032have 441b40d833fdfa93eb2908e52742248faf0ee993
0000
```
Формат такой-же как по SSH, в ответ сервер посылает статус операции и сгенерированный pack-файл.
