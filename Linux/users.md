# Пользователи

## Пользователь

Linux — многопользовательская ОС, это означает:

* В системе может быть зарегистрировано множество пользователей с разными настройками;
* Пользователи могут работать в системе одновременно.

Узнать имя текущего пользователя можно командой:

```bash
whoami
```

Узнать кто ещё работает в системе в данный момент:

```bash
who
```

Каждому пользователю соответствует группа, как минимум 1. Группы нужны для управления доступов к разделяемым ресурсам для нескольких пользователей сразу.

Посмотреть список групп:

```bash
id
```

Команда выведет информаю о текущем пользователе и список его групп.

У пользователя есть UID — это уникальный идентификатор пользовтеля в системе. В Linux есть определённые правила, по которым эти идентификаторы присваивают, например в ubuntu пользовательские номера выдаются начиная с идентификатора 1000 и выше.

Для групп есть аналогичный идентификатор — GID.

Значения UID и GID могут перескаться, но обозначают они разное.

## Суперпользователь

Помимо обычный пользователей в Linux-системах всегда присутвует суперпользователь. Обычно он имеет имя `root`. Этот пользователь обладает неограниченными правами в системе.

UID и GUI суперпользователя — 0, это зарезервированые значения для суперпользователя.

Суперпользователь в системе может быть только один.

Домашняя директория root лежит отдельно от директорай остальных пользователей в _/root_

## Смена пользователя

Исторически в Linux есть команда для выполнения команд из под другого пользовать:

```bash
su
```

Без параметров она запроси пароль суперползьователя и, после его ввода, переключает на шелл суперпользователя.

При этом происходит только смена пользователя, но не переменных окружения, такой способ считается некорректным. Чтобы заменить их нужно использовать:

```bash
su -
```

Для выхода используется команда:

```bash
exit
```

Чтобы переключиться на определённого пользователя нужно укзать его имя в 1м аргументе:

```bash
su - <username>
```

Чтобы выполнить команду из под другого пользователя без переключения нужно указать параметр `-c`:

```bash
su -c '<command>' <username>
```

На данный момент такой способ запуска команд под суперпользователем не считается безопасным, т.к. выходит, что:

* всем нужно знать пароль суперпользователя (или другого пользователя);
* доступ нельзя никак ограничить.

## Sudo

Современный способ выполнения команд из под другого пользователя является sudo.

```bash
sudo <command>
```

По умолчанию sudo будет запрашивать пароль **текущего** пользователя. Также можно сконфигурировать sudo чтобы он не запрашивал пароля вообще.

Конфигурация sudo находится в  _etc/sudoers_, там можно конфигурировать множество вещей:

* Делегировать конкретным пользователем, какие команды он может запускать;
* Какие при этом переменные окружения будут выставлены;
* Какие файлы можно читать и писать;

Редактирования файла конфигурации является опасным, неверные конфиги могут привести к поломке всей системы. Поэтому для редактирования конфига используется специальная программа:

```bash
visudo
```

Она открывается файл в редакторе (указывается в переменной окружения `EDITOR`), при выходе конфиг валидируется, если он не валиден, то программа не даст его сохранить.

Кроме того есть команда:

```bash
sudoedit
```

Позволяющая редактировать любой файл. Это нужно потому что некоторые редакторы (например vim) позволяют запускать внутри себя внешние команды, и таким образом, если выдать пользователю права на запуск такого редактора от суперпользователя, пользователю станут доступны все остальные команды посредством этого редактора. Sudoedit позволяет использовать этот редактор безопасно, т.к. он будет запущен от текущего пользоватея и при редектировании будет подменять файлы, чтобы была возможность редактировать файлы не доступные этому пользователю.

Чтобы заупстить команду от конкретного пользователя используется параметр `-u`:

```bash
sudo -u <username>
```

Для перехода в шелл пользоватея используется параметр `-i`:

```bash
sudo -i
```

`sudo` является предпочтительным способом смены пользователя, и рекомендуется к использованию вместо `su`.

## Структура учетной записи пользователя

Учётные записи пользователей находятся в обычном текстом файле _etc/passwd_.

Каждая строка в файле представляет отдельную учётную запись.

```
user:x:1000:1000::/home/user:/bin/bash
```

Она устроена так:

* Cистеменое имя пользователя;
* x (раньше здесь был зашифрованный пароль, но для безопасности его вынечли отдельно);
* UID;
* GID (группы по умолчанию);
* Описание аккаунта, может быть пустым
* Домашняя директория
* Обалочка, которая загружается после входа в систему.

У части пользователей в качестве обалочки стоит _usr/bin/nologin_, это системные пользователи, обычно у них UID и GID до 100, они нужны чтобы запускать через них программы, при этом с помощью них нельзя авторизоваться в систему.

В файле _etc/group_ описываются группы.

```
group:x:142:
```

* Название группы;
* x;
* GID;
* Список пользователей, причём если у пользователя одна группа, то он здесь не указывается, а только в _etc/passwd_.

## Управление пользователями и группами

### Группы

* Добавлеие:

```bash
groupadd <gruop>
```

* Удаление:

```
groupdel <group>
```

* Изменение:

```bash
groupmod <group> [-g <GID>] [-n <name>] [-p <password>]
```

* Список групп пользователя

```bash
groups <user>
```

### Пользователи

* Добавлеие:

```bash
useradd <user>
```

* Удаление:

```
userdel <user>
```

* Изменение:

```bash
userpmod <user> [-d <home_dir>] [-g <GID>] [-G <groups>]
```

### Группы и пользователи

Команда для управления связями групп и пользователей:

```bash
gpasswd [options] <group>
```

Опции:

* -a, --add — добавление пользователя в группу;
* -d, --delete — удаление пользователя из группы.

### Высокоуровневые команды

Помимо общих низкоуровеных команд предоставляемых во всех Linux системах в некоторых есть также свои выскороуровневые команды упрощающую работы с группами/пользователями, например в Debian системах это:

```
adduser
deluser
addgroup
delgroup
```

### Смена пароля

```bash
passwd [<user>]
```

Без аргументов меняет для текущего пользователя.

## Umask

При создании файла или каталога ему присваивается набор прав доступа по умолчанию. Для обычного файла режим доступа составляет `666`, для каталога - `777`.

Однако, если создать файл, режим доступа к нему будет `664`.

Дело в том, что на опеределяния режима доступа к новым файлам/директория влияет маска (`umask` — **u**ser file creation mode **mask**), значение которой ровно `0002` (по умолчанию в Ubuntu, в других системах может быть другое).

Посмотреть маску можно командой:

```bash
umask
```

Применение маски происходит следующим образом:

* Полный режим доступа к файлу: `rw- rw- rw-` (`110 110 110` в двоичной системе);
* Маска (без первого ведущего числа): `002: 000 000 010`;
* Доступ к файлу сопоставляется с маской, где в маске записано:
  * 0 — изменений не прохисдоит;
  * 1 — значение доступа сбраиывается и записывается 0.
* Для значения выше выходит: `110 110 100`

### Изменение маски

В рамках текущей сессии значение можно поменять командой:

```umask
umask <maks>
```

## SUID и SGID

У некоторых файлов, на месте флага `x` в правах файла может быть написано `s`, это использование SUID, это приводит к том, что программа запускается не из под текущего пользователя а из под пользователя, который её создал. Это позволяет программам не имеющим доступ к каким-то файлам менять их.

SGID — тоже самое, только для группы.

## Sticky Bit

Sticky Bit устанавливается на файлы вместо последнего `x`, вместо `x` записывается `t`, он предназначен для запрета на удаление файла для всех пользователей, при этом права доступа не имют значения. Удалить файл может только владелец файла или суперпользователь.
