# Vagrant

Инструмент для создания среды разработки на основе виртуалок.
Для работы нужен virtualBox или другая среда виртуализации.

В данный момент, в большинстве случаев его заменил docker, однако всё ещё существуют случаи когда нужно полноценная виртуализация:

- Когда нужно несколько виртуальных серверов с докером, чтобы например объединить их в куб-кластер, их можно поднять с помощью Vagrant. 
- Когда нужна определенная версия или возможности ядра линукса, или дополнительные патчи/модули к нему. 
- Когда нужен низкоуровневый доступ к сети. 
- Когда нужна графика. 
- Когда нужен доступ к физическим устройствам. 
- Когда нужен более высокий уровень изоляции для безопасности. 
- Когда нужна более точное квотирование ресурсов. 
- Когда нужно деплоить и тестировать unikernel-приложения. 
- Когда нужна архитектура процессора, отличная от хост-системы и так далее.

## Инициализация

Vagrant предпологает, что для каждого проекрта создаётся своя конфигурация, инициализация выполняется в директории проекта:

```bash
vagrant init ubuntu/focal64
```

Команда скачает окружение и создаст в директории файл `Vagrantfile`. Файл содержит описание конфига для окружения на языке Ruby. 

Другие готовые окружения можно найти [здесь](https://app.vagrantup.com/boxes/search)

## Запуск и остановка

Для запуска используется команда:

```bash
vagrant up
```

Для остановки используется команда:

```bash
vagrant halt
```

Для получения текущего статуса:

```bash
vagrant status
```

Для полного уничтожения машины используется команда:

```bash
vagrant destroy
```

## Жизненый цикл окружения Vagrant

Для входа внутрь машины используется команда:

```bash
vagrant ssh
```

Vagrnt автоматически проикидывает код в директорию _/vargant_

## Работа с сетью

По умолчанию всё что внутри не доступно снаружи, чтобы это исправить нужно пробасывать порта. Для этого в конфиге указывается:

Проброс портов:

```ruby
config.vm.network "forwarded_port", guest: 80, host: 8080
```

* guest — хост в виртуальном окружении
* host — порт на рабочей машине

Использование статичного ip

```ruby
config.vm.network "private_network", ip: "192.168.33.10"
```

Для того чтобы применить настройки в запущеном окружении:

```bash
vagrant reload
```

[Настройка сети Vagrant](https://developer.hashicorp.com/vagrant/docs/networking/basic_usage)

## Настройка окружений

Для настроек самого окружения, установки окружения поддерживаются различные системы развёртки, например `ansible`. Также возможно использовать shell-скрипты:

```ruby
Vagrant.configure("2") do |config|
  config.vm.provision "shell", path: "script.sh"
end
```

В директории рядом должен лежит файл _script.sh_ с нужными скриптами.

[Документации](https://www.vagrantup.com/docs/provisioning/)

Для запуска конфигурации:
```bash
vagrant provision
```

## Синхронизируемые директории

По умолчанию вагран синхронизирует директорию в которой лежит вагрантфайл, т.е. корень проекта, в виртуалке директорию будет лежать в `/vagrant`, владельцем директории в виртуалке является vagrant. 
Изменить это можно так:

```ruby
onfig.vm.synced_folder ".", "/vagrant", owner: "www-data",
  group: "vagrant"
```

## Работа с vagrant

### Запуск

```bash
vagrant up
```
Запустит виртуальное окржение.

### Подключение

```bash
vagrant
```
Подключится к окружению. 

По умолчанию в окружении используется пользователь vagrant.

Код проекта будет содержатся в директории `/vagrant` виртуалки.

### Остановка

```bash
vagrant halt
```
Остановит виртуалку.

```bash
vagrant reload
```
Полностью удалит всё в вирталке и создаст её заново.


## 10.0.2.2 

Из виртуального окружения хост доступен по адресу 10.0.2.2 