1. Типы БД

Всего у нас четыре сервиса:

* Каталог — документная т.к. у нас будут хранится товары с различными полями, в будущем поля могут добавляться и мы не знаем какие + документная база хорошо масштабируется, что нужно если у нас будет множество товаров.
* Цены — ключ-значение, для обеспечения наибольшей производительности.
* Заказ —  реляционная, т.к. важна целостность данных, транзакции, множество связанных данных
* Клиент — реляционная т.к. у нас есть четкая структура полей пользователя и возможности документной базы нам здесь не обязательны.

2. Модели данных

## Каталог

### Товар

| Поле                  | Тип                       | Размер записи |
| --------------------- | ------------------------- | ------------- |
| ИД                    | Целое число               | 4 байта       |
| Название              | Строка                    | 255 байт      |
| Артикул               | Строка                    | 255 байт      |
| Описание              | Текст                     | 1200 байт     |
| Ширина                | Число с плавающей запятой | 8 байт        |
| Высота                | Число с плавающей запятой | 8 байт        |
| Глубина               | Число с плавающей запятой | 8 байт        |
| Статус                | Целое число               | 1 байт        |
| Вес                   | Число с плавающей запятой | 8 байт        |
| Маленькое изображение | Строка                    | 255 байт      |
| Основное изображение  | Строка                    | 255 байт      |
| Дата создания         | Дата и время              | 8 байт        |
| Дата обновления       | Дата и время              | 8 байт        |
| Статус наличия        | Целое число               | 1 байт        |

### Изображения товара

| Поле      | Тип         | Размер записи |
| --------- | ----------- | ------------- |
| ИД        | Целое число | 4 байта       |
| ИД товара | Целое число | 4 байта       |
| Путь      | Строка      | 255 байт      |

### Категория

| Поле                      | Тип         | Размер записи |
| ------------------------- | ----------- | ------------- |
| ИД                        | Целое число | 4 байта       |
| Название                  | Строка      | 4 байта       |
| Описание                  | Текст       | 1200 байт     |
| Статус                    | Целое число | 1 байт        |
| ИД родительской категории | Целое число | 4 байта       |
| Дата создания             | Дата и время| 8 байт        |
| Дата обновления           | Дата и время| 8 байт        |

### Товары категори

| Поле         | Тип         | Размер записи |
| ------------ | ----------- | ------------- |
| ИД категории | Целое число | 4 байта       |
| ИД товара    | Целое число | 4 байта       |
| Позиция      | Целое число | 4 байта       |

## Цены

Хранилище типа ключ-значение, где ключ это ИД товара + постфикс с типом цены (обычная, спец.цена), значение — цена.

## Заказ

### Заказ

| Поле            | Тип                       | Размер записи |
| --------------- | ------------------------- | ------------- |
| ИД       | Целое число               | 4 байта       |
| Номер заказа    | Строка                    | 255 байта     |
| Итог заказа     | Число с плавающей запятой | 8 байт        |
| ИД клиента      | Целое число | 4 байта |
| Имя клиента     | Строка | 255 байта |
| Email клиента   | Строка | 255 байта |
| Телефон клиента | Строка | 255 байта |
| Статус          | Строка | 255 байта |
| Стоимость доставки | Число с плавающей запятой | 8 байт        |
| Дата доставки | Дата и время | 8 байт |
| Дата создания   | Дата и время        | 8 байт        |
| Дата обновления | Дата и время        | 8 байт        |

### Позиция заказ

| Поле            | Тип                       | Размер записи |
| --------------- | ------------------------- | ------------- |
| ИД              | Целое число               | 4 байта       |
| ИД заказа       | Целое число               | 4 байта       |
| ИД продукта     | Целое число               | 4 байта       |
| Дата создания   | Дата и время              | 8 байт        |
| Дата обновления | Дата и время              | 8 байт        |
| Итог по позиции | Число с плавающей запятой | 8 байта       |
| Название        | Строка                    | 255 байта     |
| Артикул         | Строка                    | 255 байта     |
| Количество      | Целое число               | 4 байта       |

### Склад (для позиций)

| Поле         | Тип          | Размер записи |
| ------------ | ------------ | ------------- |
| ИД позиции   | Целое число  | 4 байта       |
| ИД склада    | Целое число  | 4 байта       |
| Количество   | Целое число  | 4 байта       |
| Статус       | Целое число  | 1 байт        |
| Дата запроса | Дата и время | 8 байт        |

### Адрес

| Поле            | Тип          | Размер записи |
| --------------- | ------------ | ------------- |
| ИД              | Целое число  | 4 байта       |
| ИД заказа       | Целое число  | 4 байта       |
| Страна          | Строка       | 2 байта       |
| Регион          | Строка       | 255 байта     |
| Город           | Строка       | 255 байта     |
| Адресс          | Строка       | 255 байта     |

### Доставка

| Поле            | Тип         | Размер записи |
| --------------- | ----------- | ------------- |
| ИД              | Целое число | 4 байта       |
| ИД заказа       | Целое число | 4 байта       |
| Служба доставки | Строка      | 255 байта     |
| Трекинг номер   | Строка      | 255 байта     |

### Метод доставки

| Поле     | Тип                       | Размер записи |
| -------- | ------------------------- | ------------- |
| ИД       | Целое число               | 4 байта       |
| Код      | Строка                    | 255 байт      |
| Название | Строка                    | 255 байта     |
| Цена     | Число с плавающей запятой | 8 байта       |

### Склад

| Поле                  | Тип         | Размер записи |
| --------------------- | ----------- | ------------- |
| ИД                    | Целое число | 4 байта       |
| ИД товара             | Целое число | 4 байта       |
| Количество            | Целое число | 4 байта       |
| Минмальное количество | Целое число | 4 байта       |
| Регион                | Строка      | 255 байт      |
| Город                 | Строка      | 255 байт      |

### Матрица ростояний складов и городов

| Поле       | Тип         | Размер записи |
| ---------- | ----------- | ------------- |
| ИД склада  | Целое число | 4 байта       |
| Город      | Строка      | 255 байт      |
| Расстояние | Целое число | 4 байта       |

## Клиент

### Клиент

| Поле               | Тип                       | Размер записи |
| ------------------ | ------------------------- | ------------- |
| ИД                 | Целое число               | 4 байта       |
| Имя                | Строка                    | 255 байта     |
| email              | Строка                    | 255 байта     |
| хэш пароля         | Строка                    | 255 байта     |
| телефон            | Строка                    | 255 байта     |
| Дата создания      | Дата и время              | 8 байт        |
| Дата обновления    | Дата и время              | 8 байт        |

### Адрес

| Поле            | Тип          | Размер записи |
| --------------- | ------------ | :------------ |
| ИД              | Целое число  | 4 байта       |
| ИД клиента      | Целое число  | 4 байта       |
| Название        | Строка       | 255 байта     |
| Страна          | Строка       | 2 байта       |
| Регион          | Строка       | 255 байта     |
| Город           | Строка       | 255 байта     |
| Адресс          | Строка       | 255 байта     |
| Дата создания   | Дата и время | 8 байт        |
| Дата обновления | Дата и время | 8 байт        |
| Основной (флаг) | Целое число  | 1 байт        |

## Оценка роста данных

| Тип                                 | Назначение                                                   | Рост в месяц                                    | Рост в квартал                                    |
| ----------------------------------- | ------------------------------------------------------------ | ----------------------------------------------- | ------------------------------------------------- |
| Товар                               | Характеристики производимой продукции                        | 3 × 2274 байт харакетистик = 6822 байт          | 9 × 2274 байт харакетистик = 20466 байт           |
| Изображения товара                  | Изображения для товаров                                      | 9 × 263 байт = 2367 байт + изображения до 30 мб | 27 × 263 байт = 7101 байт  + изображения до 90 мб |
| Категория                           | Данные категории каталога                                    | В среднем 0                                     | 1 × 1229 байт                                     |
| Товары категори                     | Связи категорий и продуктов                                  | 10 × 12 кб  = 600 байт                          | 50 × 12 кб  = 600 байт                            |
| Заказ                               | Заказ                                                        | 5000 × 1323 байт = 6615000 байт                 | 15000 × 1315 байт = 19845000 байт                 |
| Позиция заказ                       | Позици заказа                                                | 12000 × 550 байт = 6600000 байт                 | 36000 × 550 байт = 19800000 байт                  |
| Склад (для позиций)                 | Информация о запрошенных на складах количестах для товаров в позициях заказов | 14000 × 21 байт = 294000 байт                   | 42000 × 21 байт = 882000 байт                     |
| Адрес (заказ)                       | Адреса заказов                                               | 5000 × 775 байт = 3875000 байт                  | 15000 × 775 байт = 11625000 байт                  |
| Доставка                            | Информация о доставке заказа                                 | 5000 × 518 байт = 2590000 байт                  | 15000 × 518 байт = 7770000 байт                   |
| Метод доставки                      | Доступные способы доставки                                   | 4 × 522 байт = 2088 байт                        | 12 × 522 байт = 6264 байт                         |
| Склад                               | Информация о количестве товара на разных складах             | 9 × 526 байт = 4734 байт                        | 27 × 526 байт = 14202 байт                        |
| Матрица ростояний складов и городов | Растояния между складами и городами доставки                 | 10 ×  263 байт = 2630 байт                      | 30 ×  263 байт = 7890 байт                        |
| Клиент                              | Аккаунт клиента                                              | 100 × 1040 байт = 104000 байт                   | 300 × 1040 = 312000 байт                          |
| Адрес (Клиент)                      | Адреса клиента                                               | 100 × 1047 байт = 104700 байт                   | 300 × 1047 байт = 314100 байт                     |

3. Заказ

   Заказ происходит следующим образом:

   1. Пользователь кладёт нужные товары в корзину
   2. Переходит на страницу оформления заказа, на ней проверяется имеется ли на складах в таблице складов нужное количество товаров, если нет, то пользователю отображается информация об этом
   3. Вводит адрес доставки
   4. Введённый адрес отправляется в сервис заказов, записывается в заказ (в статусе корзины). 
   5. В фоне сервис заказов берёт доступные склады (доступным считает тот, где количество товара больше минимального значения (после достижения минимального значения товар считается недоступным на этом складе)) для продуктов и, посредством стороннего сервиса (например Google map API или подобного) определяется расстояния от города склада до города в который хочет совершить заказа клиент, полученная информация сохраняется в таблицу с матрицей расстояний, для городов, у которых расстояния до складов уже есть в матрице запроса не происходит. Эта информация нужна будет в дальнейшем для приоритизация складов при заказе, чтобы заказ формировался на складах наиболее близких к клиенту.
   6. Пользователь оформляет заказ, начинается транзакция заказа, в базе блокируются записи складов по трубуемым продуктам, с требуемым количеством, приоритет складов считается по матрице растояний. По порядку приоритетов у каждого склада списывается доступное количество товаров (но не больше минимального), пока не будет достигнуто нужное количество. Если количество не удалось собрать, то транзакция отменяется, клиенту возвращается сообщение об отсутвии требуемого количества на складах.
   7. Создаётся заказа (статус меняется на "новый"), клиент попадает на thank-you-page, на склады отправляется информация о заказе с требуемым количестом продуктов
   8. Склад через в течении дня присылает, или подтверждение для заказа, или корректировку. Если приходит подтверждение то у записи в таблице склада для позиций заказа подтверждается запись для этого склада. Если приходит корректировка (в ней содержится информация, о количестве которое возможно доставить с этого склада), в таблице склада для позиций записывается скорректированое значение, а разница между требуемым и скорректируемым запршивается в других складоах (кроеме неподтверждённых).
   9. Если в течени двух суток по заказу не приходят подтверждения, то оператор связывается с клиентом, и сообщает об этом, заказ или отменяется по просьбе клиента или клиент соглащается ждать поставки, тогда в склад уходит повторное резервирование позиций по этому заказу
   10. Как только все запросы для складов в заказе подтверждены, в склады посылаются запросы на комплектацию заказа и информация о заказе передаётся в слежбу доставки.

   Таким образом, для заданых данных будет происходить следущие:

   1. Создаётюся заказ, (предположим что у каждого склада минмальное количесто 1шт. товара) на складе 1 запрашивается 9 шт., на складе 2 — 4 шт., на складе 3 — 7 шт.

   2. Если на складах всё в наличии, то из складов приходит подтверждение и заказ уходит на комплектацию и доставку.


Риски в данном решении:

*  Блокировка записей на складе может будет сказываться на производительности при создании заказов
* Простой товара на складах пока для заказа не будут получены все подтврждения или зкакз не будет отменён


4. Заказ (нет в наличии)

Заказ невозможно будет создать для данных условий, когда пользователь перейдёт в козину он получит сообщение о том, что запрашиваемое количества товара не доступно.

5. Цены

Если нам критично отображение корректной цены для пользователя, то для решения проблемы цен транзакции не подходят, потому что в любом случае могут быть задержки синхронизации или подтверждения и может получится что на сайтах буудт разные цены. Можно перед показом цены проверять цены на всех сайтах и пока везде цена не подтверждится выводить прежнюю, но это приведёт к сильному падению производительности и куче дополнтельных запросов на каждое отображение товара. Поэтому приемлемым решением будет вынесение логики с ценами в отдельный сервис, в котором будут хранится все цены продуктов, сервисы каталога и заказа не будут ничего знать о ценах продукта и будут получать их по запросу из общего сервиса для цен. 

Риски:

* Использование одного сервиса созадёт точку отказа, если сервис цен упадёт, то информация о ценах станет недоступна на всех сайтах, что сделает невозможным их работу
* Запросы на получение цен скзываются на производительности

6. Скидка

   Локальным складом считается склад наиболее близкий к пользователю (текущий город пользователя можно определять по геолокации/IP/брать из основного адреса клиента), расстояние определяется по матрице расстояний в сервисе заказов.

   Цена для локального склада записывается отдельно от основной.

   1. При заходе клиента на страницу товара, если для товара есть цена для локального склада и для пользователя можно определить локальный склад, то пользователю отображается информация, что этот товар доступен ему по скидке, если при этом на складе мало товара, то отображается предупреждение, что по этой цене можно будет заказать только определённое количество товаров.

   2. Если клиент кладёт товар в корзину то происходит проверка наличия товара по скидке, если товар ешё есть, то он кладётся в корзину, в складе по позициям создаётся записи о позиции заказа с этим товаром и заказным количеством, для записи ставится особый статус, из записи в таблице склада для этого товара вычитается отложенное количество, на склад отправляется информация о резервировании товара

   3. Клиент оформляет заказ

      

Если клиент не оформил заказ, то:

   1. Если корзина пользователя неактивна в течении какого-то промежутка времени, например 1 часа, то резерв с товара убирается и он становится доступен для других пользователей

   2. Если пользователь вернётся к своей корзине, то будет произведена проверка доступности покупаемого товара со скидкой, если требуемое количество есть, то оно резервируется, если нет, то пользователю отображается информация, что по этой цене товар больше не доступен и нужно удалить товар или заказать его по цене без скидки. Пока пользователь не примет решения заказ нельзя будет оформить.

      Для случаев когда пользователю нужно большее количество товара чем есть на складе со скидкой, можно добавлять в корзину этот товар как отдельную позицию с обычной ценой.

      Риски:

      * Из-за резервирование товара до фактического заказа товар может простаивать на складах пока пользователь не создаст заказа или не пройдёт время на которое товар резервируется
