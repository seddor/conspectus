# Шаблоны

## Пути файлов, fallback

Шаблоны в M2 аналогичны шаблонам из M1. Они хранятся в phtml-файлах, как правило это HTML со вставками PHP-кода.

Файлы шаблонов распологаются в(по приоритету):
1. `<theme_dir>/<Namespace_Module>/templates`
2. `<parent_theme_dir>/<Namespace_Module>/templates`
3. `<module_dir>/view/frontend/templates`
4. `<module_dir>/view/base/templates`

В таком же порядке происходит fallback, и так же можно реврайтить шаблоны. 
Файлы шаблонов могут быть только в контексте модуля.

## Подключение и связь с лаяутами

Базовый блок использующий шаблоны: `\Magento\Framework\View\Element\Tempalate`, начиная с 2.2.1 параметр блока `class` использует это значение по умолчанию.

Способы назначения шаблонов блоку(по приоритету):
1. Паметр блока `template` в лаяуте:
```xml
<block 
    class="Magento\Catalog\Block\Product\View"
    name="product.info"
    template="Magento_Catalog::product/view/form.phtml"
/>
```
Этот параметр можно менять:
```xml
<referenceBlock 
    name="breadcrumbs" 
    template="Mage_Catalog::product/breadcrumbs.phtml"
/>
```
2. В лаяуте посредством `<action>` можно вызвать метод `setTemplate`, этот способ считается устаревшим.
3. Передача аргумета `template` в конструкторе блока с использванием `<arguments>`
4. Изменить поле класса-блока `$_template`

Пути к шаблону можно задавать:
* С указанием модуля:
```
Magento_Catalog::product/view/form.phtml
```
Файл шаблона будет искаться в контексте модуля `Oggetto_Catalog`. 
* Без указания модуля:
```
order/tax.phtml
```
Шаблон будет искаться в контексте модуля блока.

## Вызов методов и связь с блоком

Здесь шаблоны M2 имеюют некоторые отличия от шаблонов из M1.

Вызовы методов блока теперь происходят через переменную `$block`, она автоматически доступна в каждом шаблоне. 

* Вызывать можно только публичные методы блока.
* Для обратной совместимости можно так-же использовать `$this`, однако такой способ является устаревшим и следует использовать `$block`. Так-же у `$this` есть метод `helper()`, создающий инстанс хелпера, одна такое использования не рекомендуется в M2.

## Передача произвольных параметров

Все параметры из лаяута переданые в `<arguments>` попадают в `_data` блока, и соотвено потом достпны из блока и его шаблонов посредством `getData('name')` или магического метода `getName()`.

```xml
<block name="test" template="test.phtml">
    <arguments>
        <argument name="title" xsi:type="string">Any string</argument>
    </arguments>
</block>
```

## Экранирование вывода

Для этого достпуны следующие функции:
* `escapeHtml()` — экранирует html-код. Вторым параметром можно указывать массив допустимых тегов, которые не будут экранированы.
* `escapeUrl()` — аналогичен `escapeHtml`, так-же не позволяет использовать псевдо-протоколы типа `javascript:`
* `escapeJs()` — экранирует js-переменные, строки и числа.
```php
var field<?= $block->escapeJs($block->getFieldNamePostfix()) ?> = '<?php echo $block->escapeJs($block->getFieldValue()) ?>';
$block->escapeHtmlAttr(...)
```
* `escapeHtmlAttr()` — используется для экранирования значения одиночного html-аттрибута

## Методы вызова потомков

В M2 родителями могут быть контейнеры и блоки. Контейнеры выводят своих детей автоматически, для блоков используются следующие методы:
* `getChildHtml()` — принимает имя или алиас дочернего блока или контейнера и возвращает его вывод. Без параметров вернёт вывод всех своих детей
* `getBlockHtml()` — похож на `getChildHtml()` работает не с дочерники элементами, а с любыми блоками на странице
* `getChildChildHtml` — похож на `getChildHtml()`, первым парметров принимает имя/алиас ребёнка, вторым имя/алиас ребёнка ребёнка, если не передать второй параметр вернёт вывод всех детей ребёнка.

## Получения значений из etc/view.xml

В _etc/view.xml_ могут хранится значение произвольных переменных:
```xml
<vars module="Magento_Wishlist">
    <var name="product_image_size">113</var>
</vars>
```
Для получения этого значения у блока есть метод `getVar`. Например:
```php
$block->getVar('product_image_size', 'Magento_Wishlist');
```
вернёт 113.

Первым парметром принимается назвавние переменной, второй контекст модуля, в котором она задана. 

## Рекомендации и view Model'и

Рекомендации при написании шаблонов:
* Использовать `<?= ?>` вместо `<php echo ?>` для вывода
* Минимизировать php-логику в шаблонах, выносить её в блоки и вью модели

В M2 рекомендуется разделять функицонал для рендеринга шаблона и прочиц функционал. Всё что связано с рендерингом должно быть в классе блока, остальное во вью моделе. Вью модель добавляется в шаблон посредством добавления через лаяут:
```xml
<block name="test" template="test.phtml">
    <arguments>
        <argument name="viewModel" xsi:type="object">Oggetto\Training\ViewModel\Product</argument>
    </arguments>
</block>
```
Затем используется в шаблоне через `$block->getViewModel`.
