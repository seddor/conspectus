# DI

DI (внедрение зависимостей) — способ управления зависимостями объекта, путём установки используемых объектов внутри конструктора текущего объекта.

В M2 DI предназначен для создания всех объектов. Нужные объекты опредлеляются в конструкторе класса, менеджер объектов создаёт нужные объекты основываясь на конфигурации. 

* все зависимости объекта передаются в объект сразу, вместо того, чтобы объект получал их из окружения
* Зависимость предпологает, что один компонент использует другой для выполнение некой функции
* Большое количество зависимостей ограничивает переиспользование кода и осложняет его перенос

## Инициализация класса

Диаграмма инициализации класса:
```
[__construct(..)] <-- [список интерфейсов, классов, фабрики используемые в текущем классе] <--> [смердженные di.xml]
```

1. `__construct` — конструктор класса, содержит список зависимостей, это могут быть другие классы, интрефейсы, фабрики и другое
2. Когда этот класс инстанцируется, механизм DI просматривает конструктор и инстанцирует зависимости на основе `di.xml`.
3. `di.xml` можно переопределить в модуле

Наиболее подохдящий тип класса для использования в DI — это singlton, например кэш, сессия, хелпер. Однако, не все классы создаются через DI, например классы сущности, такие как продукт, связаны с данными в базе и их не нужно инициализировать как sington, для них нужно использовать фабрики:

```php
public function __construct(\Magento\Catalog\Model\ProductFactory $factory)
{
    $this->factory = $factory;
}

/**
* Создание и загрузка инстанса продукта
*/
public function someFunction()
{
    $product = $this->factory->create();
    $product->load($id);
}
```

При этом класс фабрики может не существовать, механизм DI сгенерирует его автоматически, если идентифицирует класс заканчивающийся на "Factory" в списке параметров, в директории _generation_

Итого:

* Singltone — вставляется через DI
* Класс сущности — создаётся фабрикой или репозиторием
* Фабрики — генерируются автоматически
