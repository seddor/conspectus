# Конфируация модуля

Всю конфигурацию можно разделить на 3 группы:

* Application configuration — включает в себя конфигурации инстанса M2, такие как конекты к БД, конфигуация кеша, текущий режим (mode) работы M2.
* Module configuration — представляет из себя набор конфигурационных файлов в директории _etc_ модуля. Эта группа также делится на:
    * Core module configuration
    * Custom module configuration
* System configuration — конфигурация доступная для пользователя системы, она сохраняется в БД и доступна в админке.

## Appliation configuration

Находится в директории _app/etc_, содержит несколько конфигурационных файлов, наиболее интересные:

* _env.php_ — содержит информацию о конектах к БД, конфигурацию кеша, режим работы мадженты и т.п.
* _config.php_ — автоматически генерируемый файл, содержит список модулей и флагов их включености.
* _di.xml_ — содержит основные конфиги DI
* _db_schema.xml_ — содержит инструкцию для создания таблицы `path_list` используется для работы с патчами данных и схем БД.

## Module configuration

Находится в директории _etc_ или _etc/`<area>`_ модуля. Содержит множество различных xml файлов.

`<area>` может принимать значения:

* frontend
* adminhtml
* crontab
* webapi_rest
* webapi_soap

## Мердж файлов

В M2, как и в M1, используется мердж файлов конфигурации — все файлы одного типа сливаются в один общий с которым работает система.

* Ноды в конфигурационных файлах мерджатся на основе их полного `Xpaths`
* Специальные атрибуты определены в массиве `$idAttributes` и используеются как идентификаторы
* После мерджа 2х xml файлов, результирующий файл содержит все ноды из оригинальных файлов
* Второй xml файл либо дополяет, либо перезаписывает ноды первого файла

## Хранение

Имеется два основных способа хранения конфигов:

* XML — в xml файлах хранятся более технические конфигурации, которые должен изменять разработчик.
* DB — в БД конфиги хранятся в таблице `core_config_data`, эти данные доступны для просмотра и редактирования в админке.

### `core_config_data`

таблица `core_config_data` имеет следующую структуру:
```
+-----------+------------------+------+-----+---------+----------------+
| Field     | Type             | Null | Key | Default | Extra          |
+-----------+------------------+------+-----+---------+----------------+
| config_id | int(10) unsigned | NO   | PRI | NULL    | auto_increment |
| scope     | varchar(8)       | NO   | MUL | default |                |
| scope_id  | int(11)          | NO   |     | 0       |                |
| path      | varchar(255)     | NO   |     | general |                |
| value     | text             | YES  |     | NULL    |                |
+-----------+------------------+------+-----+---------+----------------+
```

`scope` может принмать значение:

* global — глобальный конфиг для всего инстанса, в этом случе в `scope_id` не используется
* website — конфиг для веб-сайта, в этом случе в `scope_id` должен содержаться ИД веб-сайта
* store — конфиг для стора, в этом случе в `scope_id` должен содержаться ИД стора

### scope для xml конфигов

Для xml конфигов имеется 3 scope:

* global — распологаются в _etc_ модуля
* frontend — распологаются в _etc/frontend_ модуля
* admin — распологаются в _etc/adminhtml_ модуля

Система загружает только нужные в данный момент scope. Не все типы конфигурации могут иметь scope, например `module.xml` может быть только глобальным. Некоторыее опции конфигурации могут работать только в одном scope.

## Валидация

M2 используется схемы в xsd файлах для валидации xml конфигов.

Например, схема для `event.xml` находится в `magento/framwork/Event/etc/events.xsd`, схема подключается следующим образом:

```xml
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:Event/etc/events.xsd">
</config>
```
